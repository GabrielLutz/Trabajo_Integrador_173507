<div class="container">
	<div class="header">
		<h1>Inscripci√≥n a Llamado</h1>
		<p *ngIf="llamado">{{ llamado.titulo }}</p>
	</div>

	<app-loading *ngIf="loading"></app-loading>
	<app-error-message *ngIf="error" [message]="error"></app-error-message>

	<div class="inscripcion-container" *ngIf="!loading && llamado">
		<div class="stepper">
			<div
				*ngFor="let paso of pasos; let i = index"
				class="step"
				[class.active]="i === pasoActual"
				[class.completed]="i < pasoActual"
				(click)="irAPaso(i)">
				<div class="step-number">
					<span *ngIf="i < pasoActual">‚úì</span>
					<span *ngIf="i >= pasoActual">{{ i + 1 }}</span>
				</div>
				<div class="step-title">{{ paso.titulo }}</div>
				<div class="step-line" *ngIf="i < pasos.length - 1"></div>
			</div>
		</div>

		<div class="step-content">
			<div *ngIf="pasoActual === 0" class="paso-content">
				<h2>Seleccione Departamento</h2>
				<p class="subtitle">Elija el departamento al que desea postularse</p>

				<form [formGroup]="formDepartamento">
					<div class="departamentos-grid">
						<label
							*ngFor="let dept of llamado.departamentos"
							class="departamento-option"
							[class.selected]="formDepartamento.value.departamentoId === dept.departamentoId">
							<input
								type="radio"
								[value]="dept.departamentoId"
								formControlName="departamentoId">
							<div class="departamento-card">
								<h3>{{ dept.nombre }}</h3>
								<p>{{ dept.cantidadPuestos }} puesto(s) disponible(s)</p>
							</div>
						</label>
					</div>
				</form>
			</div>

			<div *ngIf="pasoActual === 1" class="paso-content">
				<h2>Autodefinici√≥n seg√∫n Ley</h2>
				<p class="subtitle">De acuerdo a la legislaci√≥n vigente, marque si corresponde:</p>

				<form [formGroup]="formAutodefinicion">
					<div class="checkbox-group">
						<label class="checkbox-option">
							<input type="checkbox" formControlName="esAfrodescendiente">
							<div class="checkbox-content">
								<h3>Afrodescendiente</h3>
								<p>Me autodefino como afrodescendiente (Ley 19.122)</p>
							</div>
						</label>

						<label class="checkbox-option">
							<input type="checkbox" formControlName="esTrans">
							<div class="checkbox-content">
								<h3>Trans</h3>
								<p>Me autodefino como persona trans (Ley 19.684)</p>
							</div>
						</label>

						<label class="checkbox-option">
							<input type="checkbox" formControlName="tieneDiscapacidad">
							<div class="checkbox-content">
								<h3>Discapacidad</h3>
								<p>Tengo certificado de discapacidad</p>
							</div>
						</label>
					</div>

					<div class="info-box">
						<strong>Importante:</strong> Esta informaci√≥n es confidencial y se utiliza √∫nicamente para el cumplimiento de las cuotas establecidas por ley.
					</div>
				</form>
			</div>

			<div *ngIf="pasoActual === 2" class="paso-content">
				<h2>Requisitos Excluyentes</h2>
				<p class="subtitle">Indique si cumple con cada uno de los requisitos:</p>

				<form [formGroup]="formRequisitos">
					<div class="requisitos-list" formArrayName="requisitos">
						<div
							*ngFor="let group of requisitosArray.controls; let i = index"
							class="requisito-item"
							[formGroupName]="i">
							<div class="requisito-header">
								<h3>{{ llamado.requisitosExcluyentes[i].descripcion }}</h3>
								<span class="badge" *ngIf="llamado.requisitosExcluyentes[i].obligatorio">OBLIGATORIO</span>
							</div>
							<p class="tipo">{{ llamado.requisitosExcluyentes[i].tipo }}</p>

							<div class="radio-group">
								<label>
									<input type="radio" formControlName="cumple" [value]="true">
									S√≠, cumplo
								</label>
								<label>
									<input type="radio" formControlName="cumple" [value]="false">
									No cumplo
								</label>
							</div>

							<div class="form-group">
								<label>Observaciones (opcional)</label>
								<textarea
									formControlName="observaciones"
									placeholder="Agregue observaciones si lo desea..."
									rows="2"></textarea>
							</div>
						</div>
					</div>
				</form>
			</div>

			<div *ngIf="pasoActual === 3" class="paso-content">
				<h2>M√©ritos y Antecedentes</h2>
				<p class="subtitle">Seleccione los m√©ritos que posee y adjunte documentaci√≥n de respaldo:</p>

				<form [formGroup]="formMeritos">
						<div class="meritos-list" formArrayName="meritos">
							<div
								*ngFor="let group of meritosArray.controls; let i = index"
								class="merito-item"
								[formGroupName]="i">
							<div class="merito-header">
								<div class="checkbox-wrapper">
									<input type="checkbox" formControlName="seleccionado" [id]="'merito_' + llamado.itemsPuntuables[i].id">
									<label [for]="'merito_' + llamado.itemsPuntuables[i].id">
										<h3>{{ llamado.itemsPuntuables[i].nombre }}</h3>
									</label>
								</div>
								<span class="puntaje">{{ llamado.itemsPuntuables[i].puntajeMaximo }} pts</span>
							</div>

							<p class="categoria">{{ llamado.itemsPuntuables[i].categoria }}</p>
							<p class="descripcion">{{ llamado.itemsPuntuables[i].descripcion }}</p>

							<div class="upload-area" *ngIf="meritosArray.at(i).controls.seleccionado.value">
								<input
									type="file"
									[id]="'file_' + llamado.itemsPuntuables[i].id"
									hidden
									#fileInput>
								<label [for]="'file_' + llamado.itemsPuntuables[i].id" class="upload-btn">
									üìé Adjuntar Documento
								</label>
								<span class="file-info">
									{{ meritosArray.at(i).controls.documentoRespaldo.value ? meritosArray.at(i).controls.documentoRespaldo.value : 'PDF, JPG, PNG (m√°x. 10MB)' }}
								</span>
							</div>
						</div>
					</div>
				</form>
			</div>

			<div *ngIf="pasoActual === 4" class="paso-content">
				<h2>Apoyos Necesarios</h2>
				<p class="subtitle">Seleccione los apoyos que requiera para el proceso:</p>

				<form [formGroup]="formApoyos">
					<div class="apoyos-list" formArrayName="apoyosSeleccionados">
						<label
							*ngFor="let apoyo of llamado.apoyosNecesarios; let i = index"
							class="apoyo-option">
							<input
								type="checkbox"
								[formControlName]="i">
							<div class="apoyo-content">
								<h3>{{ apoyo.descripcion }}</h3>
								<p class="tipo">{{ apoyo.tipo }}</p>
							</div>
						</label>
					</div>

					<div class="info-box">
						Los apoyos solicitados ser√°n evaluados y confirmados por el tribunal evaluador.
					</div>
				</form>
			</div>

			<div *ngIf="pasoActual === 5" class="paso-content">
				<h2>Confirmaci√≥n de Inscripci√≥n</h2>
				<p class="subtitle">Revise los datos antes de confirmar su inscripci√≥n:</p>

				<div class="resumen-container">
					<div class="resumen-section">
						<h3>Llamado</h3>
						<p>{{ llamado.titulo }}</p>
					</div>

					<div class="resumen-section">
						<h3>Departamento</h3>
						<p>{{ obtenerNombreDepartamento() }}</p>
					</div>

					<div class="resumen-section">
						<h3>Autodefinici√≥n</h3>
						<ul>
							<li *ngIf="formAutodefinicion.value.esAfrodescendiente">‚úì Afrodescendiente</li>
							<li *ngIf="formAutodefinicion.value.esTrans">‚úì Trans</li>
							<li *ngIf="formAutodefinicion.value.tieneDiscapacidad">‚úì Discapacidad</li>
							<li *ngIf="!formAutodefinicion.value.esAfrodescendiente && !formAutodefinicion.value.esTrans && !formAutodefinicion.value.tieneDiscapacidad">
								No aplica
							</li>
						</ul>
					</div>

					<div class="resumen-section">
						<h3>Requisitos Declarados</h3>
						<p>{{ contarRequisitos() }} requisito(s) cumplidos de {{ requisitosArray.length }}</p>
					</div>

					<div class="resumen-section">
						<h3>M√©ritos Presentados</h3>
						<p>{{ contarMeritos() }} m√©rito(s) seleccionado(s)</p>
					</div>

					<div class="resumen-section" *ngIf="contarApoyos() > 0">
						<h3>Apoyos Solicitados</h3>
						<p>{{ contarApoyos() }} apoyo(s) solicitado(s)</p>
					</div>
				</div>

				<div class="confirmacion-box">
					<label class="checkbox-confirm">
						<input type="checkbox" [(ngModel)]="aceptaTerminos" [ngModelOptions]="{ standalone: true }">
						<span>
							Declaro que la informaci√≥n proporcionada es ver√≠dica y acepto los
							<a href="/terminos" target="_blank">t√©rminos y condiciones</a>.
						</span>
					</label>
				</div>
			</div>
		</div>

		<div class="actions">
			<button
				class="btn btn-secondary"
				(click)="pasoAnterior()"
				*ngIf="pasoActual > 0"
				[disabled]="loading">
				‚Üê Anterior
			</button>

			<button
				class="btn btn-outline"
				(click)="cancelar()"
				[disabled]="loading">
				Cancelar
			</button>

			<button
				class="btn btn-primary"
				(click)="siguientePaso()"
				*ngIf="pasoActual < pasos.length - 1"
				[disabled]="loading">
				Siguiente ‚Üí
			</button>

			<button
				class="btn btn-primary btn-lg"
				(click)="enviarInscripcion()"
				*ngIf="pasoActual === pasos.length - 1"
				[disabled]="!aceptaTerminos || loading">
				{{ loading ? 'Enviando...' : 'Confirmar Inscripci√≥n' }}
			</button>
		</div>
	</div>
</div>
